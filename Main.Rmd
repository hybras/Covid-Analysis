---
title: "Main"
author: "Team 12"
date: "11/12/2020"
output: 
  html_document:
    code_folding: hide
---

NOTE: All code blocks are folded by default. Access by clicking code button next to the text block. (Or open all at once with the button on the top right)

## Setup

Download data, install packages and load libraries

```{r libs}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(janitor)
library(gganimate)
library(gifski)
library(png)
library(ggrepel)
library(scales)
library(maps)
```

Download and read data.

```{r Initial_Data}
base_url <- "https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/"

time_series_US_confirmed <- "csse_covid_19_time_series/time_series_covid19_confirmed_US.csv"

time_series_US_confirmed <- paste(base_url, time_series_US_confirmed, sep = "")
time_series_US_confirmed <- read.csv(time_series_US_confirmed)

social_distancing = read.csv("./legislation-data/social_distancing_history_march_to_july_inclusive.csv")
```

Get the data we *want*. Columns $\left[1,11\right]$ are locale identifiers. Columns $\left[12,\infty\right)$ are dates. The data is more granular than state, it goes down to town/county. We need to fix that.

```{r clean_data}
last_column <- length(time_series_US_confirmed)

# There are 11 columns of data that are not case (mostly related ot location), so the total number of days there is data for will be the length of the dataframe minus 11.
num_days <- last_column - 11

# Data is more granular than state, it goes down to town/county. We need to group them together by state.
by_state <-
	time_series_US_confirmed %>% select(c(7, 12:all_of(last_column))) %>% group_by(Province_State) %>% summarize_at(vars(2:all_of(num_days)), sum)
# %>% adorn_totals('row') #idk what this does

# we are using another library for state names. it expects lower cases names
by_state$Province_State <-
	tolower(by_state$Province_State)

# get the contiguous/continental us states, including D.C.
cont_states <-
	map_data("state")$region %>% unique()
# limit ourselves to continental US
by_state <-
	by_state %>% filter(Province_State %in%  cont_states) %>% dplyr::rename(region = Province_State)

# get the dates in the format given to us: XM.DD.YY (the 'X' is a char literal of unknown purpose)
# Add 1 because we're starting from 2, to get the columns we need
# 2020/1/22 is the first date in the set
col_names <- colnames(by_state)[c(2:all_of(num_days + 1))]
new_col_names <-
	seq(as.Date("2020/1/22"), by = "day", length.out = num_days)
by_state <- by_state %>%
	setNames(new_col_names) %>%
	dplyr::rename(region = "2020-01-22")

#Prepare data for plotting, flatten the data
by_state.long_1 <- pivot_longer(
  by_state,
  cols = c(2:all_of(num_days)),
  names_to = "date",
  values_to = "cases"
)

# Helper function to generate plots. Can be animated.
plot_cases <-
	function(cases,
			 scaled = FALSE,
			 start_date = as.Date("2020-1-22"),
			 end_date = Sys.Date() - 1,
			 title = "Confirmed Cases vs Time") {
		plot_1 <- cases %>% ggplot(aes(
			x = as.Date(date),
			y = if (scaled)
				scaled_cases
			else
				cases,
			group = region,
			color = region
		)) +
			labs(title,
				 x = "Date",
				 y = "Number of Cases") +
			geom_line() +
			# Assuming the data goes up to yesterday.
			scale_x_date(
				limits = c(as.Date("2020-1-22"), Sys.Date() - 1),
				date_breaks = "1 month",
				date_labels = "%B"
			) +
			scale_y_continuous(labels = scales::comma) +
			theme(
				plot.title = element_text(
					color = "black",
					size = 14,
					face = "bold.italic"
				),
				axis.title.x = element_text(color = "black", size = 10),
				axis.title.y = element_text(color = "black", size = 10),
			)
		return(plot_1)
	}
```

Basic plots lifted from profs code.

```{r plot}
fav_states <-
	c("new york", "florida", "texas", "california", "maryland")
data_fav_states <-
	by_state.long_1 %>% filter(region %in% fav_states)

plot_1 <- data_fav_states %>%
	plot_cases()

# And now the time series as a fancy gif.

animation_1 <- plot_1 + transition_reveal(as.Date(date))
animation_1 <- animate(
  animation_1,
  width = 750,
  height = 650,
  duration = 20,
  end_pause = 20,
  renderer = gifski_renderer()
)
animation_1
```

The same thing again, but scaled to cases per 100000 people

```{r normalized}
# Get population information about the states
census_url <- "https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/state/detail/SCPRC-EST2019-18+POP-RES.csv"
census <- read.csv(census_url)
census$NAME <- tolower(census$NAME)

# Create a new dataframe to store the scaled data
data_scaled <-
	data.frame(region = vector(),
			   date = vector(),
			   cases = vector())

# For each state in the selected list, find that states population, divide all of the case counts by the population and merge the scaled data back into the dataframe
for (state in fav_states) {
  data_scaled <- data_fav_states %>%
    filter(region == state) %>%
    mutate(scaled_cases = (cases / filter(census, NAME == state)$POPESTIMATE2019) * 100000) %>%
    merge(data_scaled, all = TRUE)
}
```

Scaled plots.

```{r scaled_gif}
plot_2 <- data_scaled %>%
	plot_cases(scaled = T, title = "Confirmed Cases per 100,000 People vs Time")

animation_2 <- plot_2 + transition_reveal(as.Date(date))
animation_2 <- animate(
  animation_2,
  width = 750,
  height = 650,
  duration = 20,
  end_pause = 20,
  renderer = gifski_renderer()
)
animation_2
```

Helper function that plots covid case with stay at home order overlayed

```{r stay_at_home}
plot_legislation_overlay <-
	function (state,
			  legislation,
			  legislationcolor) {
		# first letter of state should be capitalized (eg. "Maryland")
		# legislation is numeric - see following
		# 1 = stay at home order, 2 = mandatory quarantine for travelers, 3 = non essential business closures
		# 4 = large gatherings ban, 5 = school closures, 6 = restaurant limits
		legislation_matrix = c(
			"stay at home order",
			"mandatory quarantine for travelers",
			"non essential business closures",
			"large gatherings ban",
			"school closures",
			"restaurant limits"
		)
		state_legis_data <- social_distancing %>% filter(State == state)
		les_start = state_legis_data[legislation + 1][[1]]
		les_end = state_legis_data[legislation + 9][[1]]
		not_enacted = FALSE
		# check whether date is valid or NA
		if (les_start == "-") {
			# legislation was never enacted
			not_enacted = TRUE
		} else if (les_end == "-") {
			# legislation was never lifted
			les_start = as.Date(les_start, format = "%d-%b")
			les_end = as.Date("2077-4-02")
		} else {
			les_start = as.Date(les_start, format = "%d-%b")
			les_end = as.Date(les_end, format = "%d-%b")
		}
		state = tolower(state)
		state_data <- by_state.long_1 %>% filter(region == state)
		
		plot <- state_data %>%
			plot_cases(
				title = paste(paste(
					paste("COVID case data with", legislation_matrix[legislation], sep = " "),
					"overlayed -",
					sep = " "
				), state, sep = " "),
				start_date = as.Date("2020-3-01"),
				end_date = as.Date("2020-7-31")
			)
		
		if (not_enacted)
			plot
		else
			plot + annotate(
				"rect",
				xmin = les_start,
				xmax = les_end,
				ymin = 0,
				ymax = Inf,
				alpha = 0.2,
				fill = legislationcolor
			)
	}
```
